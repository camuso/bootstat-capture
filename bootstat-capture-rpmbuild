#!/bin/bash
# bootstat-capture-rpmbuild - Build bootstat-capture RPM package

set -e

VERSION=1.0
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TMPDIR=$(mktemp -d)
trap "rm -rf ${TMPDIR}" EXIT

echo "Creating source tarball..."
echo "Using source directory: ${SCRIPT_DIR}"

# Verify required files exist
for file in bootstat capture-boot capture-boot.service capture-shutdown capture-shutdown.service CAPTURE-SHUTDOWN-README bootstat-capture.spec; do
    if [ ! -f "${SCRIPT_DIR}/${file}" ]; then
        echo "Error: Required file ${file} not found in ${SCRIPT_DIR}" >&2
        exit 1
    fi
done

# Verify service files have correct paths
if ! grep -q 'ExecStart=/usr/bin/' "${SCRIPT_DIR}/capture-boot.service"; then
    echo "Warning: capture-boot.service does not have /usr/bin/ path!" >&2
    echo "Current ExecStart line:" >&2
    grep ExecStart "${SCRIPT_DIR}/capture-boot.service" >&2
    exit 1
fi

# Create temporary directory with version name
mkdir -p "${TMPDIR}/bootstat-capture-${VERSION}"

# Copy files into the directory (exclude capture-install as it's not packaged)
cp "${SCRIPT_DIR}/bootstat" \
   "${SCRIPT_DIR}/capture-boot" \
   "${SCRIPT_DIR}/capture-boot.service" \
   "${SCRIPT_DIR}/capture-shutdown" \
   "${SCRIPT_DIR}/capture-shutdown.service" \
   "${SCRIPT_DIR}/CAPTURE-SHUTDOWN-README" \
   "${TMPDIR}/bootstat-capture-${VERSION}/"

# Create tarball from the directory
cd "${TMPDIR}"
tar czf "${SCRIPT_DIR}/bootstat-capture-${VERSION}.tar.gz" "bootstat-capture-${VERSION}/"

echo "Source tarball created: bootstat-capture-${VERSION}.tar.gz"

# Verify service files in tarball have correct paths
echo "Verifying service files in tarball..."
tar -xzf "${SCRIPT_DIR}/bootstat-capture-${VERSION}.tar.gz" -O "bootstat-capture-${VERSION}/capture-boot.service" | grep ExecStart
tar -xzf "${SCRIPT_DIR}/bootstat-capture-${VERSION}.tar.gz" -O "bootstat-capture-${VERSION}/capture-shutdown.service" | grep ExecStart

# Create local RPM build directory structure
RPMBUILD_DIR="${SCRIPT_DIR}/rpmbuild"
echo "Creating local RPM build directory structure in ${RPMBUILD_DIR}..."
mkdir -p "${RPMBUILD_DIR}"/{SOURCES,SPECS,BUILD,RPMS,SRPMS}

# Copy tarball to local SOURCES
echo "Copying tarball to ${RPMBUILD_DIR}/SOURCES/..."
cp "${SCRIPT_DIR}/bootstat-capture-${VERSION}.tar.gz" "${RPMBUILD_DIR}/SOURCES/"

# Copy spec file to local SPECS
echo "Copying spec file to ${RPMBUILD_DIR}/SPECS/..."
cp "${SCRIPT_DIR}/bootstat-capture.spec" "${RPMBUILD_DIR}/SPECS/"

# Build RPM using local build directory
echo "Building RPM using local build directory..."
rpmbuild --define "_topdir ${RPMBUILD_DIR}" -ba "${RPMBUILD_DIR}/SPECS/bootstat-capture.spec"

# Find the newest built RPM file (most recently modified)
# Sort by modification time, newest first, and take the first one
RPM_FILE=$(ls -t "${RPMBUILD_DIR}"/RPMS/*/bootstat-capture-${VERSION}-*.noarch.rpm 2>/dev/null | head -1)
if [ -z "${RPM_FILE}" ]; then
    # Fallback: search recursively if not in expected location
    RPM_FILE=$(find "${RPMBUILD_DIR}/RPMS" -name "bootstat-capture-${VERSION}-*.noarch.rpm" -type f -exec ls -t {} + 2>/dev/null | head -1)
fi

if [ -n "${RPM_FILE}" ]; then
    # Remove older versions of RPM files from top directory
    echo ""
    echo "Removing older RPM files from ${SCRIPT_DIR}/..."
    for old_rpm in "${SCRIPT_DIR}"/bootstat-capture-*.rpm; do
        if [ -f "$old_rpm" ] && [ "$(basename "$old_rpm")" != "$(basename "${RPM_FILE}")" ]; then
            echo "Removing older RPM: $(basename "$old_rpm")"
            rm -f "$old_rpm"
        fi
    done
 
    # Remove any .src.rpm files from top directory
    for old_srpm in "${SCRIPT_DIR}"/bootstat-capture-*.src.rpm; do
        if [ -f "$old_srpm" ]; then
            echo "Removing SRPM: $(basename "$old_srpm")"
            rm -f "$old_srpm"
        fi
    done

    # Copy new RPM to script directory
    echo "Copying new RPM to ${SCRIPT_DIR}/..."
    cp "${RPM_FILE}" "${SCRIPT_DIR}/"
    echo "RPM copied to: ${SCRIPT_DIR}/$(basename "${RPM_FILE}")"
fi

echo ""
echo "RPM build complete!"
echo "RPM location:"
ls -lh "${RPMBUILD_DIR}/RPMS/noarch/bootstat-capture-${VERSION}-"*.noarch.rpm 2>/dev/null || \
    find "${RPMBUILD_DIR}/RPMS" -name "bootstat-capture-${VERSION}-*.noarch.rpm" -ls
echo ""
echo "Source RPM location:"
ls -lh "${RPMBUILD_DIR}/SRPMS/bootstat-capture-${VERSION}-"*.src.rpm 2>/dev/null || \
    find "${RPMBUILD_DIR}/SRPMS" -name "bootstat-capture-${VERSION}-*.src.rpm" -ls
echo ""
echo "RPM files copied to: ${SCRIPT_DIR}/"
ls -lh "${SCRIPT_DIR}/bootstat-capture-${VERSION}-"*.rpm 2>/dev/null || echo "No RPM files found in script directory"

