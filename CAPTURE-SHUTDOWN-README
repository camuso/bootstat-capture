# capture-shutdown and capture-boot - Preserve Shutdown Stack Traces Across Boots

## Overview

`capture-shutdown` and `capture-boot` are companion scripts to `bootstat` that capture kernel messages
and dmesg output during shutdown and immediately on boot. This allows `bootstat` to detect stack traces
that occurred during shutdown, which would otherwise be lost when the system reboots.

### Critical Limitation: Very Late Shutdown Messages

**BUG traces and kernel messages that occur during the kernel reboot sequence** (after "reboot: Restarting system"
message) **cannot be captured by user-space scripts** because they happen after systemd has killed all user-space
processes. 

**To capture these very late shutdown messages, you MUST use one of these methods:**
- **Remote console logging** (serial console, IPMI SOL, etc.) - captures console output during reboot
- **Kernel crash dumps (kdump)** - if configured, can capture kernel state during crashes
- **Video console capture** - framebuffer capture (if available)

The `capture-shutdown` and `capture-boot` scripts will capture traces that occur *before* the kernel reboot
sequence begins, but traces during the actual reboot sequence (when user-space processes are killed) require
the console capture mechanisms listed above.

### Components

- **capture-shutdown**: Captures dmesg during shutdown (runs as a systemd service before shutdown.target)
- **capture-boot**: Captures dmesg immediately on boot before it's cleared (runs early in boot process)
- Both scripts save traces to `/var/log/shutdown-traces/` for analysis by `bootstat`

## Quick Installation

The easiest way to install both scripts and services is using the installation script:

```bash
sudo ./capture-install
```

Or if the script is not executable:

```bash
sudo bash capture-install
```

This will:
- Install scripts to `/usr/local/bin/`
- Install systemd service files to `/etc/systemd/system/`
- Create the log directory `/var/log/shutdown-traces/`
- Enable and start the services

## Manual Installation

If you prefer to install manually:

### 1. Install Scripts

Copy scripts to `/usr/local/bin/` and make them executable:

```bash
sudo cp capture-shutdown capture-boot /usr/local/bin/
sudo chmod +x /usr/local/bin/capture-shutdown
sudo chmod +x /usr/local/bin/capture-boot
```

### 2. Install Systemd Services

Copy service files to `/etc/systemd/system/`:

```bash
sudo cp capture-shutdown.service capture-boot.service /etc/systemd/system/
```

### 3. Create Log Directory

Create the directory for storing traces:

```bash
sudo mkdir -p /var/log/shutdown-traces
sudo chmod 755 /var/log/shutdown-traces
```

### 4. Enable and Start Services

Reload systemd and enable the services:

```bash
sudo systemctl daemon-reload
sudo systemctl enable capture-shutdown.service
sudo systemctl enable capture-boot.service
sudo systemctl start capture-boot.service
```

## How It Works

### capture-shutdown

- Runs during shutdown (before `shutdown.target`) as a systemd service
- Captures:
  - Current dmesg output (multiple times with delays to catch messages during shutdown)
  - Messages from `/proc/kmsg` stream (reads continuously during shutdown sequence)
  - Recent kernel messages from journalctl (if available)
  - Kernel log files (`/var/log/kern.log`, `/var/log/messages`)
- Saves everything to `/var/log/shutdown-traces/shutdown-YYYYMMDD-HHMMSS.log`
- Automatically cleans up old traces, keeping only the most recent 10 (configurable)
- **Note**: Cannot capture messages that occur after systemd kills all processes during reboot sequence

### capture-boot

- Runs very early in boot (after `sysinit.target`, before `basic.target`)
- Captures dmesg immediately before it's cleared by the kernel
- Also reads from `/dev/kmsg` to catch any messages not yet in dmesg
- Saves ALL traces found (not just ones with reboot context)
- Saves traces to `/var/log/shutdown-traces/boot-capture-YYYYMMDD-HHMMSS.log`
- Only saves files if traces are detected (panics, oops, BUGs, etc.)

### Why Both?

Some kernel bugs occur during the reboot sequence itself, after systemd services have stopped.
In these cases:
- `capture-shutdown` runs during shutdown but may be killed before the reboot sequence completes
- `capture-boot` captures dmesg on the next boot before it's cleared, preserving traces from the previous shutdown
- Together they provide comprehensive coverage of shutdown traces

**However**, traces that occur very late in the reboot sequence (after user-space processes are killed)
will not be captured by either script and require remote console logging or kdump.

## Configuration

You can customize the script behavior:

### capture-shutdown Options

- **Log directory**: Use `-d` or `--dir` to specify a different directory
- **Max traces**: Use `-m` or `--max` to keep more/fewer old traces

Example:
```bash
capture-shutdown --dir /var/log/my-traces --max 20
```

### capture-boot

`capture-boot` runs automatically and doesn't accept command-line arguments. It saves traces
if any critical errors (panics, oops, BUGs) are detected in dmesg, regardless of reboot context.

## Integration with bootstat

`bootstat` automatically checks `/var/log/shutdown-traces/` for saved shutdown traces.
When you run `bootstat` or `bootstat -v`, it will:
- Detect if there are traces in saved shutdown files (`shutdown-*.log`)
- Detect if there are traces in boot-capture files (`boot-capture-*.log`)
- Show them in verbose output (`-v` flag)
- Report shutdown errors even if the journal doesn't persist across boots
- Display "[OK] Clean boot" if no traces are found, or show detected traces

Example usage:
```bash
bootstat          # Quick check for shutdown errors
bootstat -v       # Verbose output showing detected traces
```

## Service Management

### Check Service Status

```bash
sudo systemctl status capture-shutdown.service
sudo systemctl status capture-boot.service
```

### View Service Logs

```bash
sudo journalctl -u capture-shutdown.service
sudo journalctl -u capture-boot.service
```

### View Captured Traces

```bash
ls -lh /var/log/shutdown-traces/
cat /var/log/shutdown-traces/shutdown-*.log
cat /var/log/shutdown-traces/boot-capture-*.log
```

## Manual Testing

You can test the scripts manually:

### Test capture-shutdown

```bash
sudo /usr/local/bin/capture-shutdown
ls -lh /var/log/shutdown-traces/
```

### Test capture-boot

```bash
sudo /usr/local/bin/capture-boot
ls -lh /var/log/shutdown-traces/
```

Note: `capture-boot` only saves files if it finds critical traces (panics, oops, BUGs, etc.) in dmesg.

## Uninstallation

To uninstall both scripts and services:

```bash
sudo ./capture-install --uninstall
```

Or:

```bash
sudo bash capture-install --uninstall
```

Or manually:

```bash
sudo systemctl stop capture-boot.service
sudo systemctl disable capture-shutdown.service capture-boot.service
sudo rm /etc/systemd/system/capture-shutdown.service
sudo rm /etc/systemd/system/capture-boot.service
sudo rm /usr/local/bin/capture-shutdown
sudo rm /usr/local/bin/capture-boot
sudo systemctl daemon-reload
```

Note: The log directory `/var/log/shutdown-traces/` is not removed automatically.
To remove it manually: `sudo rm -rf /var/log/shutdown-traces`

## Troubleshooting

### Services Not Starting

If services fail to start:

1. Check service status:
   ```bash
   sudo systemctl status capture-shutdown.service
   sudo systemctl status capture-boot.service
   ```

2. Check service logs:
   ```bash
   sudo journalctl -u capture-shutdown.service -n 50
   sudo journalctl -u capture-boot.service -n 50
   ```

3. Verify scripts are executable:
   ```bash
   ls -l /usr/local/bin/capture-shutdown
   ls -l /usr/local/bin/capture-boot
   ```

4. Test scripts manually:
   ```bash
   sudo /usr/local/bin/capture-shutdown
   sudo /usr/local/bin/capture-boot
   ```

### Traces Not Being Captured

- Verify the log directory exists and is writable:
  ```bash
  ls -ld /var/log/shutdown-traces
  ```

- Check if services are enabled:
  ```bash
  systemctl is-enabled capture-shutdown.service
  systemctl is-enabled capture-boot.service
  ```

- Check disk space:
  ```bash
  df -h /var/log
  ```

### capture-boot Not Finding Traces

`capture-boot` only saves files if it finds critical traces (panics, oops, BUGs, etc.) in dmesg.
If you're not seeing `boot-capture-*.log` files, it means:
- No critical traces were found in dmesg (this is good!)
- The traces occurred too late in the reboot sequence and weren't preserved in dmesg

This is normal behavior - `capture-boot` is designed to only save files when traces are detected.

### Very Late Shutdown Traces Not Captured

If you know a BUG trace occurs during shutdown but neither `capture-shutdown` nor `capture-boot`
captures it, the trace is likely occurring during the kernel reboot sequence after user-space
processes are killed. In this case:

1. **Check remote console logs** (serial console, IPMI SOL, etc.) - these capture console output
   during the entire reboot sequence
2. **Configure kdump** - if the system crashes, kdump can capture kernel state
3. **Use video console capture** - if available, can capture framebuffer output

The `capture-shutdown` and `capture-boot` scripts cannot capture messages that occur after
systemd kills all user-space processes.

## Notes

- `capture-shutdown` runs during shutdown with a 30-second timeout to allow reading from `/proc/kmsg`
- `capture-boot` runs very early in boot with a 5-second timeout
- Both scripts capture dmesg which may be large - ensure `/var/log` has sufficient space
- Old traces are automatically cleaned up to prevent disk space issues (keeps most recent 10 by default)
- The scripts are designed to be silent on success and only log errors
- **Important**: Messages that occur during the kernel reboot sequence (after "reboot: Restarting system")
  cannot be captured by these scripts and require remote console logging or kdump

## Files Installed

After installation, the following files are installed:

- `/usr/local/bin/capture-shutdown` - Shutdown capture script
- `/usr/local/bin/capture-boot` - Boot capture script
- `/etc/systemd/system/capture-shutdown.service` - Systemd service for shutdown capture
- `/etc/systemd/system/capture-boot.service` - Systemd service for boot capture
- `/var/log/shutdown-traces/` - Directory for storing captured traces

## See Also

- `bootstat` - Check boot status and detect shutdown errors
- `capture-install` - Installation script

## Summary

The `capture-shutdown` and `capture-boot` tools work together with `bootstat` to detect and preserve
shutdown-related kernel traces across reboots. However, **very late shutdown messages** (those occurring
during the kernel reboot sequence after user-space processes are killed) **cannot be captured by these
scripts** and require:

- **Remote console logging** (serial console, IPMI SOL, etc.)
- **Kernel crash dumps (kdump)** - if configured
- **Video console capture** - framebuffer capture (if available)

For all other shutdown traces, the capture tools provide comprehensive coverage.

